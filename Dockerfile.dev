ARG RUBY_VERSION=2.6
FROM ruby:${RUBY_VERSION}

# Build dependencies for native gems (zookeeper, etc.)
RUN apt-get update && apt-get install -y \
    build-essential \
    zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy dependency files first for layer caching
COPY nerve.gemspec Gemfile ./
COPY lib/nerve/version.rb lib/nerve/

# CFLAGS workaround for zookeeper gem build issue
# See: https://github.com/zk-ruby/zookeeper/issues/85
RUN CFLAGS=-Wno-error=format-overflow bundle install

# Copy the rest
COPY . .

CMD ["bundle", "exec", "rspec"]
